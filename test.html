<html>

<head>
	<script src="jquery1.6-min.js" type="text/javascript"></script>
	<script src="util.js" type="text/javascript"></script>
	<style type="text/css" media="screen">
	* {
	  margin: 0;
	  padding:0;
	}
	.s {
		position: absolute;
		font-family: arial;
		width: 30px;
		height: 30px;
		text-align: center;
		font-size: 2em;
	}
	#fuse {
	  position: absolute;
	  bottom: 10px;
	  left: 50%;
	}
	#banner {
	  position: absolute;
	  width: 70%;
	  height: 200px;
	  background: cyan;
	  font-size: 4em;
	  text-align: center;
	  left: 15%;
	}
	</style>
	<title>Welcome, my friend!</title>
</head>
<html>
<canvas id="foo" height="100" width="100"></canvas>

<a href="#" id="fuse">Fire!</a>

<img id="logo" src="pusher_logo_150.png" style="display: none">
<img id="cannon" src="images/cannon.png" style="display: none">
<img id="monkey" src="images/monkey.png" style="display: none">
<img id="explosion" src="images/explosion.png" style="display: none">

<div id="banner">  
  Hello
</div>
</html>

<script type="text/javascript" charset="utf-8">
  var canvas = document.getElementById('foo');
  canvas.width = window.innerWidth
  canvas.height = window.innerHeight
  var ctx = canvas.getContext('2d');
  var img = document.getElementById('cannon');
  var RAD = Math.PI/180.0;
  var sprites = [];
  var gravity = new Vector(0, 0.5)
  var frameNum = 0;
  
  var stage
  var cannons = []
  var cords = []
  var monkeys = []
  var banner = null
  $().ready(function(){
    stage = {
      height: window.innerHeight,
      width: window.innerWidth
    }
    $('#fuse').click(function(){
      cannons.forEach(function(c){
        c.fire();
      })
      return false;
    })
    var leftCannon = new Cannon(new Vector(70, stage.height - 70), 45)
    sprites.push( leftCannon );
    cannons.push( leftCannon );
    var rightCannon = new Cannon(new Vector(stage.width - 70, stage.height - 70), -45)
    sprites.push( rightCannon );
    cannons.push( rightCannon );
    
    banner = new Banner()
    sprites.push( banner )
    
    var chord = new Cord(new Vector(70, 200), banner) 
    sprites.push(chord);
    cords.push(chord);
    var chord = new Cord(new Vector(stage.width - 70, 200), banner) 
    sprites.push(chord);
    cords.push(chord);
  });

  var Cord = function(p, banner){
    this.relPosition = p
    this.position = this.relPosition
    this.vector = new Vector(0, 0)
    this.basePosition = banner.position
  }
  Cord.prototype = {
    width: 5,
    height: 200,
    update: function(){
      var tmpPosition = this.basePosition.clone()
      tmpPosition.add(this.relPosition)
      this.position = tmpPosition
    },
    avatar: document.getElementById('cannon'),
    draw: function(ctx){
      ctx.fillRect(this.position.x, this.position.y, this.width, this.height)
    }
  }
  
  var Explosion = function(p){
    this.position = p
    this.width= 100
    this.height= 100
    this.age = 0
  }
  Explosion.prototype = {
    update: function(){
      if (this.age > 5){
        this.deleted = true
      } else {
        this.height *= 1.25
        this.width *= 1.25
      }
      this.age++
    },
    avatar: document.getElementById('explosion'),
    draw: function(ctx){
      ctx.save()
  		ctx.translate(this.position.x, this.position.y);
  		ctx.rotate(this.angle);
      ctx.drawImage(this.avatar, -(this.width /2), -(this.height /2), this.width, this.height)
  		ctx.restore()
    }
  }
  
  var Cannon = function(p, a){
    this.position = p;
    this.angle = a;
  }
  Cannon.prototype = {
    width: 100,
    height: 100,
    update: function(){},
    fire: function(){
      var monkey = new Monkey(this.position.clone(), new Vector(0, -40).rotate(this.angle))
      sprites.push(monkey)
      monkeys.push(monkey)
      sprites.push(new Explosion(this.position.clone()))
    },
    avatar: document.getElementById('cannon'),
    draw: function(ctx){
      ctx.save()
  		ctx.translate(this.position.x, this.position.y);
  		ctx.rotate(this.angle);
      ctx.drawImage(this.avatar, -(this.width /2), -(this.height /2), this.width, this.height)
  		ctx.restore()
    }
  }
  
  var Monkey = function(p, v){
    this.basePosition = new Vector(0, 0)
    this.position = p
    this.vector = v
  }
  Monkey.prototype = {
    update: function(){
      if (!this.attached){
        this.angle = this.vector.theta() - (90 /RAD)
        this.vector.add(gravity)
        this.position.add(this.vector)
        this.currentPosition = this.position
      } else {
        this.position = this.basePosition + this.currentPosition
      }
    },
    avatar: document.getElementById('monkey'),
    draw: function(ctx){
      ctx.save()
  		ctx.translate(Math.floor(this.position.x), Math.floor(this.position.y));
  		ctx.rotate(this.angle);
  		var width = 100
  		var height = 100
      ctx.drawImage(this.avatar, (frameNum % 4) * width, 0, width, height, -(width/2), -(height/2), width, height)
  		ctx.restore()
    },
    attach: function(){
      this.attached = true
      this.angle = 90
    }
  }
  
  
  var Banner = function(p){
    this.el = $('#banner')
    this.position = new Vector(0, -$('#banner').height())
    this.vector = new Vector(0, 0)
  }
  Banner.prototype = {
    update: function(){
      if( this.falling && this.position.y < 50){
        this.vector.add(gravity)
        this.position.add(this.vector)
      }
    },
    
    draw: function(){
      this.el.css( 'top', this.position.y +'px')
    },
    
    startFall: function(){
      if (!this.falling)
        this.falling = true
    }
  };
  
  var redraw = function(sprite){
    sprite.draw(ctx)
  };
	
	var clearStage = function(){
    ctx.clearRect(0, 0, stage.width, stage.height);
	}
	
  var interval = setInterval(function(){
    frameNum++
		clearStage()
		for (var i=0; i < sprites.length; i++) {
	    if(sprites[i].deleted)
	      sprites.splice(i, 1)
	  }
	  
		monkeys.forEach(function(monkey){
		  cords.forEach(function(cord){
		    if (
		      Math.abs(cord.position.x - monkey.position.x) < 20 &&
		      monkey.position.y < 200
		    ){
		      monkey.attach(cord);
		      banner.startFall()
		    }
		  })
		});
    for (var i=0; i < sprites.length; i++) {
      var sprite = sprites[i]
      if (sprite && sprite.position.y < canvas.height + 20){
        sprite.update()
        redraw(sprite)
      } else {
        // sprites[i] = null
      }
    };
  }, 50);

</script>
</html>
